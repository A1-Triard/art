Одна из первых вещей, которые требуется поменять в свежеустановленной системе -- шрифты и раскладки клавиатуры.
С дефолтными обычно имеется несколько проблем: 1) шрифт в терминале (здесь и далее под терминалом я подразумеваю
``настоящий'' терминал, сиречь tty) слишком мелкий, 2) эстетика некоторых букв неидеальна, 3) шрифт в консоли
(а под этим словом я подразумеваю GUI программу -- эмулятор терминала) безобразно гладкий и отличается от
шрифта в терминале, 4) возможности набирать русские буквы нет, либо же есть, но переключение между языками ужасное,
5) в Иксах нет возможности набирать типографские символы (в терминале тоже, но в терминале
это не особо нужно, даже для цели написания таких вот текстов).

Кастомный шрифт в терминале
---------------------------

Первое, что нужно сделать -- обзавестись хорошим растровым шрифтом. И если для базовой латиницы таких шрифтов,
возможно, несколько (но это не точно), то с учётом кириллицы и юникода выбора вообще не остаётся, и Terminus --
это единственный вариант. Так что в этом месте нужно пойти в интернет и раздобыть две вещи: 1) сам Terminus в виде
архива `.tar.gz` и 2) веб-страничку этого шрифта, которая содержит важную информацию относительно настраиваемых
вариантов некоторых букв и которая, тем не менее, почему-то не входит в тарбол.

Далее следуют привычные и очевидные для линуксоида вещи -- распаковка тарбола и изучение readme файла. Ну а далее
всё просто. Во-первых нужно определиться с альтернативными начертаниями и применить необходимые патчи (подробности
в readme). Далее нужно решить, какой размер и начертание шрифта вам подходит. Я обычно использую 9x18, жирное
начертание. Выбранный шрифт можно отредактировать с помощью `gbdfed`.

Так, в шрифт, которым я пользуюсь прямо
сейчас, внесены следующие исправления: 1) изменено начертание русско-латинской большой буквы ``A'', так что она имеет
вид, схожий с видом этой буквы в классическом ДОС шрифте, 2) изменено начертание кириллического ``Ээ оборотного'',
так что его труднее спутать с ``Зз'', 3) изменено начертание строчной кириллической буквы ``б'', так как дефолтный
вариант имеет не вполне органичный вид для русского языка, 4) изменено начертание заглавной буквы ``Ф'' -- она
стала более ``скромной'', 5) изменено очертание твёрдого знака -- он стал поуже, а палочка, отличающая его от
мягкого знака, заметнее, 6) изменено очертание буквы ``Ыы'' опять же по мотивам известного досовского
шрифта, 7) изменено начертание цифры ``3'', чтобы не путать её с буквой ``З''. Соответствующие патчи можно
найти [на гитхабе](https://github.com/A1-Triard/XTerminus).

В Linux терминале максимальное число доступных символов -- 256. Какие именно 256 символов будут доступны определяется
картами в каталоге `uni`. В качестве основы для украинского, русского и белорусского языков лучше всего подходит
карта `koi8-u.uni`. Напишем два микроскрипта на питоне для конвертации карты в более удобный для редактирования формат и
обратно.

Туда -- `uni_to_chars.py`:

```python
import fileinput

for line in fileinput.input():
    print(chr(int(line, 16)))
```

Обратно -- `chars_to_uni.py`:

```python
import fileinput

for line in fileinput.input():
    print("{0:04X}".format(ord(line.strip('\r\n'))))
```

Далее всё просто. Конвертируем:

```sh
$ python uni_to_chars.py < koi8-u.uni > koi8-u
```

и редактируем `koi8-u`. Я рекомендую добавить в него все изменения, соответствующие разнице между KOI8-RU 
и KOI8-U, только для ``Ўў'' найти место получше, чем в оригинале, -- например на местах ``╒'' и ``╡''.
Также лично я предпочитаю пожертвовать знаком ``reserved'' и оставить доступным символ градуса. Кроме того,
рекомендую добавить юникодный дефис (``‐'', U+2010), тем более что для него есть отличное место ``╞''.
Наконец (в том числе для целей псевдографики) имеет смысл вернуть точку-умножение U+2219 ``∙''
на законное место, которое занято невесть как затесавшимся сюда маркером списка U+2022 (``•'').
И последнее: GCC любит использовать юникодные одиночные кавычки в своём выводе (U+2018 ``‘'' и U+2019 ``’''),
так что имеет смысл вписать и их.
Предлагаемые мной изменения также доступны в виде патча [там же](https://github.com/A1-Triard/XTerminus).

Конвертируем карту обратно:

```sh
$ python chars_to_uni.py < koi8-u > koi8-u.uni
```

Выбрав и отредактировав шрифт и карту символов, переходим к сборке:

```sh
$ ./configure
$ make # gmake в FreeBSD
```

Инсталляция сводится к размещению шрифта в правильном месте.

В линуксах читаем `man setfont`, используем `.psf` файл:

```sh
$ cp ter-u18b.psf xter-u18b.psf
$ gzip -9 xter-u18b.psf
# mv xter-u18b.psf.gz /usr/share/kbd/consolefonts
# chown root:root /usr/share/kbd/consolefonts/xter-u18b.psf
# chmod u=rw,g=r,o=r /usr/share/kbd/consolefonts/xter-u18b.psf
```

В FreeBSD читаем `man vt` и раздел ``Virtual Consoles and Terminals'' в Hanbook,
и превращаем `.bdf` в `.fnt` с помощью `vtfontcvt`:

```sh
$ vtfontcvt -o xter-u18b.fnt ter-u18b.bdf
# mv xter-u18b.fnt /usr/share/vt/fonts
# chown root:root /usr/share/vt/fonts/xter-u18b.fnt
# chmod u=rw,g=r,o=r /usr/share/vt/fonts/xter-u18b.fnt
```

Осталось указать системе использовать наш шрифт.

В FreeBSD это делается с помощью настройки `allscreens_flags` в `/etc/rc.conf`:

```
allscreens_flags="-f xter-u18b"
```

В линуксах настройка дистроспецифична, точнее она зависит от системы инициализации.
В случае systemd это настраивается установкой `FONT` в `/etc/vconsole.conf`:

```
FONT="xter-u18b"
```

В случае использования системы инициализации OpenRC, нужная опция называется `consolefont` и
располагается в `/etc/conf.d/consolefont`:

```
consolefont="xter-u18b"
```

В Artix с OpenRC надо прописывать шрифт в оба места: и в `/etc/conf.d/consolefont`, и дополнительно в
`/etc/vconsole.conf` для `mkinitcpio` (а точнее для хука `/usr/lib/initcpio/install/consolefont`).

В Slackware нужно просто вписать вызов `setfont` с нужными параметрами в `/etc/rc.d/rc.font`:

```
/usr/bin/setfont xter-u18b
```

Но если нужно загрузить шрифт так же и в initrd, я не представляю как это можно сделать в Slackware.

Шрифт в загрузчике
------------------

Если хочется использовать тот же шрифт и в меню загрузчика,
вот как это делается для Arch-like линуксов и загрузчика GRUB 2.

1. Шрифт в `.pf2` формате кладётся в `/boot/grub/fonts`:

   ```sh
   $ grub-mkfont -o xter-u18b.pf2 ter-u18b.bdf
   # mv xter-u18b.pf2 /boot/grub/fonts
   ```

2. Затем шрифт прописывается в `/etc/default/grub`:

   ```
   GRUB_FONT="/boot/grub/fonts/xter-u18b.pf2"
   ```

3. Регенерируется реальный конфиг груба:

   ```sh
   # grub-mkconfig -o /boot/grub/grub.cfg
   ```

Всё, можно перезагружаться и проверять результат.

Шрифт в консоли
---------------

Следующая задача -- запихнуть тот же самый шрифт в Иксы, чтобы иметь возможность использовать его в
эмуляторе терминала.

Современные иксовые приложения не особенно любят растровые шрифты, особенно в ``традиционном''
формате `.pcf`, поэтому необходимо использовать более ``модный'' `.otb`. Конвертация проста:

```sh
$ fonttosfnt -o xter-u18b.otb ter-u18b.bdf
```

Однако, перед этим может быть небесполезным поменять название кастомного шрифта в `.bdf` файле,
чтобы если что он не перепутался с оригинальным Terminus.

Запихивать такой шрифт в систему не вполне правильно, да и не нужно: в `~/.local/share/fonts` ему будет вполне
комфортно. (В прежние времена для этой цели использовалась `~/.fonts`, но в рамках борьбы с загаживанием home dir,
фонты переехали в указанное выше место.)

Чтобы Иксы обновили список доступный шрифтов, необходимо позвать `fc-cache -fv`. Однако очень вероятно, что
так сразу шрифт не найдётся. Моё основанное на личном опыте заключение таково:
в FreeBSD больше никаких телодвижений не требуется, а вот в линуксе скорее всего
придётся найти способ включить растровые шрифты.

Правда, способ этот скорее всего весьма универсален: надо просто прочитать `/etc/fonts/conf.d/README`, и,
прочитав, обратить внимание на файлики с названиями `70-yes-bitmaps.conf` и `70-no-bitmaps.conf` в
`/etc/fonts/conf.d` и `/usr/share/fontconfig/conf.avail` (последняя директория может располагаться и в ином месте,
но `locate conf.avail` должен справиться с поиском). Дальнейшие действия очевидны: отключить отключение растровых
шрифтов путём удаления линка на файл `70-no-bitmaps.conf` и включить включение растровых шрифтов путём создания
линка на `70-yes-bitmaps.conf`. Этого должно быть достаточно, чтобы `fc-cache -fv` нашёл-таки наш шрифт, после чего
(Иксы лучше перезапустить) наш кастомный шрифт будет можно выбрать в настройках программы -- эмулятора терминала.

Шрифт в досбоксе
----------------

Для совсем странных людей, использующих досовские приложения на постоянной основе и/или для перфекционистов,
опишу также как засунуть кастомный шрифт в DOSBox.

Во-первых надо иметь в виду, что русская страница в досбоксе -- не 866, а 808. Собственно, разница между ними только
в символе евро, так что сделать `ibm-808.uni` из `ibm-866.uni` несложно. Для себя я, конечно,
[сохранил](https://github.com/A1-Triard/XTerminus/blob/master/uni/ibm-808)
готовую карту для 808 страницы, нужно только её преобразовать в `.uni` всё тем же скриптом:

```sh
$ python chars_to_uni.py < ibm-808 > ibm-808.uni
```

Покопавшись в мейкфайле терминуса, мне удалось сделать скрипт для конструирования ДОС-шрифта. Выглядит
[он](https://github.com/A1-Triard/XTerminus/blob/master/dos) так:

```sh
#!/bin/sh
set -eu

cd "$(dirname "$(realpath "$0")")"

python bin/ucstoany.py ter-u14b.bdf IBM CP808 uni/cntrl.uni uni/ascii-h.uni uni/ibm-808.uni > ts14_808.bdf
python bin/bdftopsf.py -r -G ts14_808.bdf dup/cntrl.dup dup/ascii-h.dup dup/ibm-437.dup > ts14_808.fnt
rm -f ts14_808.bdf
python bin/ucstoany.py ter-u16b.bdf IBM CP808 uni/cntrl.uni uni/ascii-h.uni uni/ibm-808.uni > ts16_808.bdf
python bin/bdftopsf.py -r -G ts16_808.bdf dup/cntrl.dup dup/ascii-h.dup dup/ibm-437.dup > ts16_808.fnt
rm -f ts16_808.bdf
```

В результате формируются два `.fnt`-файла с красивыми именами формата 8.3 --
`ts14_808.fnt` с шрифтом размером 8x14 и `ts16_808.fnt` с 8x16.

Чтобы использовать эти шрифты, потребуется установить русификатор, например, знаменитый
[KeyRus](http://old-dos.ru/index.php?page=files&mode=files&do=show&id=328).

После установки русификатора (скажем в `C:\KEYRUS`) его нужно прописать в автозапуск
(секция `[autoexec]` конфига досбокса):

```
@C:\KEYRUS\KEYRUS
```

(Конечно, перед этим диск `C` должен быть смонтирован.)

Кастомные шрифты надо закинуть в папку русификатора. Далее в досбоксе запускаем конфигуратор:

```sh
CD C:\KEYRUS
SETUP
```

В программе заходим в `Блок поддержки дисплея`, затем `Фонт 8x14`. Соглашаемся на редактирование шрифта (``фонта'').
Запускается редактор. Выбираем `File` и `Load font`.
В поле имени файла меняем редактируемый файл на наш шрифт (`C:\KEYRUS\TS14_808.FNT`).
Затем выбираем `File`, `Write to ...` и вводим прежнее имя (`C:\KEYRUS\_08X14.FNT`).
Соглашаемся перезаписать существующий файл, после чего выходим из редактора (`Quit`).

Далее проделываем аналогичную процедуру для шрифта 8x16. После этого нажимаем `Esc` несколько раз, чтобы выйти в корневое меню
и закрыть программу. Соглашаемся записать информацию на диск. Перезапускаем досбокс.

После этих действий можно будет любоваться кастомным шрифтом в текстовом режиме ДОСа.

Продолжение следует...
